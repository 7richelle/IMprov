{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Select Duration</title>
  <link rel="stylesheet" href="{% static 'task_duration.css' %}">
</head>
<body>
  <div class="dashboard">
    <header class="top-bar">
      <a href="{% url 'task_dashboard' %}" class="home-link">üè† Home</a>

      <div class="right-buttons">
        <a href="{% url 'leaderboard' %}" class="progress-link">Leaderboard</a>
        <a href="{% url 'task_summary' %}" class="progress-link">Summary</a>
        <a href="{% url 'user_progress' %}" class="progress-link">Progress</a>
        <a href="{% url 'profile_user' %}" class="progress-link">Profile</a>

        <form action="{% url 'login' %}" method="post" class="logout-form">
          {% csrf_token %}
          <button type="submit" class="logout-btn">Logout</button>
        </form>
      </div>
    </header>

    <main class="task-container">
      <form onsubmit="event.preventDefault(); generateTask();" class="task-form">
        <section class="task-section">
          <h2>‚è± Task Duration</h2>
          <p>How long do you want to spend on your task?</p>

          <div class="difficulty">
            <label class="difficulty-btn">
              <input type="radio" name="duration" value="5min" required>
              <span>5 mins<br><small>Quick boost</small></span>
            </label>

            <label class="difficulty-btn">
              <input type="radio" name="duration" value="10min">
              <span>10 mins<br><small>Short focus</small></span>
            </label>

            <label class="difficulty-btn">
              <input type="radio" name="duration" value="30min">
              <span>30 mins<br><small>Deep work</small></span>
            </label>

            <label class="difficulty-btn">
              <input type="radio" name="duration" value="1hr">
              <span>1 hour<br><small>Power session</small></span>
            </label>
          </div>
        </section>

        <button type="submit" class="next-btn">Generate Task ‚Üí</button>
      </form>

      <div id="output" style="margin-top:20px; font-weight:bold;"></div>
    </main>
  </div>

  <script>
    async function generateTask() {
      const type = "{{ request.GET.type }}";
      const difficulty = "{{ request.GET.difficulty }}";
      const frequency = "{{ request.GET.frequency }}";
      const durationInput = document.querySelector('input[name="duration"]:checked');

      if (!durationInput) {
        document.getElementById("output").innerHTML = "‚ö†Ô∏è Please select a duration.";
        return;
      }

      const duration = durationInput.value;
      const email = "{{ user_email }}";
      document.getElementById("output").innerHTML = "‚è≥ Generating task...";

      try {
        const res = await fetch("/generate-task/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type, difficulty, frequency, duration, email })
        });

        const data = await res.json();
        if (data.success) {
          const task = encodeURIComponent(data.generated_task);
          window.location.href = `/result/?task=${task}&duration=${duration}&task_id=${data.task_id}`;
        } else {
          document.getElementById("output").innerHTML =
            `‚ùå Error: ${data.error || "Could not generate task"}`;
        }
      } catch (err) {
        console.error(err);
        document.getElementById("output").innerHTML = "‚ö†Ô∏è Failed to reach server.";
      }
    }
  </script>
</body>
</html>
